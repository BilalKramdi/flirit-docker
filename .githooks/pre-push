#!/bin/sh

# Git hook pre-push pour automatiser les migrations Hasura

echo "ğŸ” VÃ©rification des changements Hasura avant push..."

# VÃ©rifier s'il y a des changements Hasura non commitÃ©es
if [ -f "hasura/.hasura-changes" ]; then
    echo "ğŸ”„ Changements Hasura dÃ©tectÃ©s, gÃ©nÃ©ration des migrations..."
    
    # Lire les migrations depuis le fichier de changements
    while IFS= read -r line; do
        if [[ $line == *": auto_migration_"* ]]; then
            MIGRATION_NAME=$(echo "$line" | cut -d':' -f2 | xargs)
            echo "ğŸ“‹ Migration trouvÃ©e: $MIGRATION_NAME"
            
            # Valider la migration
            MIGRATION_PATH="hasura/migrations/default/$MIGRATION_NAME"
            if [ -f "$MIGRATION_PATH/up.sql" ]; then
                echo "ğŸ” Validation de $MIGRATION_NAME..."
                ./scripts/validate-migration.sh "$MIGRATION_PATH/up.sql"
                
                if [ $? -eq 1 ]; then
                    echo "âŒ Migration dangereuse dÃ©tectÃ©e: $MIGRATION_NAME"
                    echo "ğŸš« Push annulÃ© pour des raisons de sÃ©curitÃ©"
                    exit 1
                elif [ $? -eq 2 ]; then
                    echo "âš ï¸  Migration avec warnings: $MIGRATION_NAME"
                    echo "ğŸ¤” Voulez-vous continuer? (y/N)"
                    read -r response
                    if [ "$response" != "y" ] && [ "$response" != "Y" ]; then
                        echo "âŒ Push annulÃ© par l'utilisateur"
                        exit 1
                    fi
                fi
            fi
        fi
    done < "hasura/.hasura-changes"
    
    # Ajouter les fichiers gÃ©nÃ©rÃ©s au commit si ils ne sont pas dÃ©jÃ  trackÃ©s
    echo "ğŸ“¦ Ajout des migrations au repository..."
    git add hasura/migrations/
    git add hasura/metadata/
    
    # Nettoyer le fichier de changements
    rm -f "hasura/.hasura-changes"
    
    echo "âœ… Migrations validÃ©es et ajoutÃ©es au repository"
else
    echo "â„¹ï¸  Aucun changement Hasura dÃ©tectÃ©"
fi

echo "ğŸš€ Push autorisÃ©"
exit 0