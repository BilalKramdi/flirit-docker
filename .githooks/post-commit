#!/bin/sh

# Git hook post-commit pour backup automatique apr√®s commit

echo "üíæ Cr√©ation d'une sauvegarde post-commit..."

# V√©rifier si Docker Compose est en cours d'ex√©cution
if docker-compose ps postgres | grep -q "Up"; then
    echo "üì¶ PostgreSQL d√©tect√© en cours d'ex√©cution"
    
    # Cr√©er une sauvegarde avec tag du commit
    COMMIT_HASH=$(git rev-parse --short HEAD)
    BACKUP_NAME="post_commit_${COMMIT_HASH}_$(date +%Y%m%d_%H%M%S).sql"
    
    echo "üíæ Cr√©ation de la sauvegarde: $BACKUP_NAME"
    
    # Ex√©cuter le backup via Docker
    docker-compose exec -T postgres sh -c "
        POSTGRES_HOST=localhost \
        POSTGRES_DB=postgres \
        POSTGRES_USER=postgres \
        POSTGRES_PASSWORD=postgrespassword \
        pg_dump -h localhost -U postgres -d postgres --clean --no-owner --no-privileges --format=custom | gzip > /backups/$BACKUP_NAME.gz
    "
    
    if [ $? -eq 0 ]; then
        echo "‚úÖ Sauvegarde post-commit cr√©√©e: $BACKUP_NAME.gz"
    else
        echo "‚ö†Ô∏è  Erreur lors de la sauvegarde post-commit"
    fi
else
    echo "‚ÑπÔ∏è  PostgreSQL non d√©marr√©, sauvegarde ignor√©e"
fi